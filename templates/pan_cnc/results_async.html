{% extends base_html|default:'pan_cnc/base.html' %}
{% load static %}

{% block content %}
    <script type="text/javascript">
        let time_left = 5;
        let cancel_countdown = false;

        function updateOutput() {
            time_left = 5;
            $.get('/logs').done(function (json_data) {
                console.log(json_data);

                let msg = '';
                let status = '';
                let returncode = 255;

                if (typeof (json_data) === "string") {
                    msg = 'Error executing task';
                    status = 'exited';
                    returncode = 255;
                } else {
                    // let json_data = JSON.parse(data);
                    msg = json_data['output'];
                    status = json_data['status'];
                    returncode = json_data['returncode'];

                    if ('captured_output' in json_data) {
                        console.log(json_data['captured_output']);
                        msg = "Completed Execution";
                    }
                }

                $('#results').html(msg);
                if (status !== 'exited') {
                    console.log('checking again');
                    countdown();
                    setTimeout(updateOutput, 5000);
                } else {
                    let c = $('#countdown');
                    c.empty();
                    cancel_countdown = true;

                    let f = $('#footer');
                    let t = $('#results_title');

                    let next_link = $('<a/>');
                    if (returncode === 0) {
                        let old_title = t.html();
                        t.html("Completed: {{ view.service.label }}");
                        {% if request.session.task_next %}
                            next_link.attr('href', '/next_task');
                            next_link.html('Continue');
                            next_link.addClass('btn').addClass('btn-primary');
                        {% else %}
                            next_link.attr('href', '{{ request.session.last_page|urlencode }}');
                            next_link.html('Continue');
                            next_link.addClass('btn').addClass('btn-primary');
                        {% endif %}
                    } else {
                        next_link.attr('href', '{{ request.session.last_page|urlencode }}');
                        next_link.html('Continue');
                        next_link.addClass('btn').addClass('btn-danger');
                        c.append('Error Executing Task');
                        c.append('<br>');
                    }
                    f.append(next_link);
                }
            })
                .fail(function () {
                    let c = $('#countdown');
                    c.empty();
                    cancel_countdown = true;
                    let next_link = $('<a/>');
                    next_link.attr('href', '{{ request.session.last_page|urlencode }}');
                    next_link.html('Continue');
                    next_link.addClass('btn').addClass('btn-danger');
                    c.append('Error Executing Task');
                    c.append('<br>');
                    let f = $('#footer');
                    f.append(next_link);});
        }

        function countdown() {
            let c = $('#countdown');
            if (cancel_countdown === true) {
                c.empty();
                return;
            }
            c.html('Checking again in ' + time_left);
            time_left = time_left - 1;
            console.log(time_left);
            if (time_left > 0) {
                setTimeout(countdown, 1000);
            }
        }
        {%  if not error %}
            {%  if not completed %}
                $(document).ready(function () {
                    setTimeout(updateOutput, 1000);
                });
            {%  endif %}
        {%  endif %}

    </script>
    <div class="card border-primary mb-5 shadow-lg">
        <div class="card-header">
            {% if header %}
                {{ header }}
            {% else %}
                Results
            {% endif %}
            <div class="float-right">
                <a href="/cancel_task" title="Cancel Task">
                    <i class="fas fa-trash-alt text-danger mr-1"></i>
                </a>
            </div>
        </div>
        <div class="card-body">
            <h4 class="card-title" id="results_title">
                {% if title %}
                    {{ title }}
                {% else %}
                    Output
                {% endif %}
            </h4>
            <div class="card-text">
                <p>{{ view_message }}</p>
                <pre id="results" class="pb-4">{{ results }}</pre>
                <pre id="countdown"></pre>
            </div>

        </div>
        <div class="card-footer text-right">
            <p class="card-text" id="footer">
                {% if request.session.next_step %}
                    {% if request.session.last_step %}
                        <a href="/workflow/{{ request.session.next_step }}" class="btn btn-primary">Complete</a>
                    {% else %}
                        <a href="/workflow/{{ request.session.next_step }}" class="btn btn-primary">Continue</a>
                    {% endif %}
                {% elif completed %}
                    <a href="{{ request.session.last_page|urlencode }}" class="btn btn-primary">Continue</a>
                {% endif %}
            </p>
        </div>
    </div>
{% endblock %}